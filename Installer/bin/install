#!/bin/bash
# This script is used to install the package.
echo "HermesOS Installer"
echo "=================="
echo "This script will install HermesOS on your system."

echo "Please enter valid location. Leave it blank to install on the current device."
read -p "Enter the location: " location

if [[ "$location" == "" ]] || [[ "$location" == " " ]] || [[ -z "$location" ]]; then
    location="$ROOTFS"
else
    disploc="$location"
    location="$ROOTFS/../$location"
    location="$(realpath "$location")"
fi

if [[ -d "$location" ]]; then
    echo "Device found: $disploc"
else
    echo "Device not found: $disploc"
    exit 1
fi

echo "Are you sure you want to install HermesOS on $disploc?"
read -p "Enter your choice (y/n): " choice
if [[ "$choice" == "y" ]] || [[ "$choice" == "Y" ]]; then
    :
else
    echo "Aborting..."
    exit 1
fi

echo "Clear space?"
read -p "Enter your choice (y/n): " format

if [[ "$format" == "y" ]] || [[ "$format" == "Y" ]]; then
    echo "Formatting..."
    rm -rf "$location/*"
fi

echo "Please select the installation mode:"
echo "1. Minimum"
echo "2. Default"

read -p "Enter your choice: " choice

PKGPTH="$SYSTEM/Installer/packages"
PKGREQUIRED="$PKGPTH/hermes-kernel-2x* $PKGPTH/liteos* $PKGPTH/hermes-services-core* $PKGPTH/core-binaries*"
PKGADDITIONAL="$PKGPTH/hermes-services* $PKGPTH/virtualization* $PKGPTH/legacy-support*"

if [ "$choice" == "1" ] || [ "$choice" == "2" ]; then
    echo "Installing minimum packages..."
    "$LIBRARY/tape/bin/tape-install" $PKGREQUIRED --target="$location"
else
    echo "Invalid choice."
    exit 1
fi

if [ "$choice" == "2" ]; then
    echo "Installing additional packages..."
    "$LIBRARY/tape/bin/tape-install" $PKGADDITIONAL --target="$location"
fi

echo "Writing startup queue defaults..."
echo "rm -rf \"\$DATA\" 2>/dev/null" > "$location/STARTUP.LSC"
echo "rm -rf \"\$LIBRARY\" 2>/dev/null" >> "$location/STARTUP.LSC"

echo "Shutting down!"
mkdir -p "$CACHE"
touch "$CACHE/stdown"
exit 0
