#!/bin/bash
@IMPORT Interface
if [[ ! -f "$NVRAM/update-install" ]]; then
	verbose "[*] No request."
	exit 0
else
	rm "$NVRAM/update-install"
	verbose "[*] Update detected."
	verbose "[*] Updating system image..."
	verbose "[*] Checking upgrade source..."
	if [[ ! -f "$NVRAM/upgrade.dmg" ]]; then
		verbose "[-] Unable to update: Missing required file - $NVRAM/upgrade.dmg"
		Interface.addAlert "System update failed: Missing required files"
		exit 0
	fi
	verbose "[*] Checking permission on system partition..."
	touch "$SYSTEM/onwrite" 2>/dev/null
	if [[ ! -f "$SYSTEM/onwrite" ]]; then
		verbose "[*] Remount required."
		if [[ ! -d "$DISKSTORE_REALPATH" ]]; then
			verbose "[-] System image realpath not detected. Unable to continue update process."
			Interface.addAlert "System update failed: System image realpath not detected."
			exit 0
		else
			verbose "[*] Remounting /System..."
			hdiutil detach "$ROOTFS/System" -force >/dev/null
			hdiutil attach "$DISKSTORE_REALPATH/system.dmg" -mountpoint "$ROOTFS/System" >/dev/null
			export attachExitCode=$?
			touch "$SYSTEM/onwrite" 2>/dev/null
			if [[ "$attachExitCode" -ne "0" ]] || [[ ! -f "$SYSTEM/onwrite" ]]; then
				verbose "[-] System remount failed."
				Interface.addAlert "System update failed: System remount as read and write failed."
				export attachExitCode=""
				exit 0
			fi
			export attachExitCode=""
		fi
	fi
	rm -f "$SYSTEM/onwrite"
	verbose "[*] Mounting system partition..."
	mkdir -p "$DATA/mount/upgrade"
	hdiutil attach "$NVRAM/upgrade.dmg" -mountpoint "$DATA/mount/upgrade" -readonly >/dev/null
	verbose "[*] Making a backup point."
	mkdir -p "$DATA/preupgrade.system"
	cp -r "$SYSTEM/" "$DATA/preupgrade.system/"
	verbose "[*] Finished backup point generate."
	verbose "[*] Upgrading system with simple copy..."
	cp -rv "$DATA/mount/upgrade/"* "$SYSTEM/"
	verbose "[*] Upgrade complete."
	touch "$CACHE/upgraded"
	Interface.addAlert "Your system is now upgraded."
	ALIVE=$(ps -ax | grep "$SYSTEM/frameworks[/]")
	echo "$ALIVE" | while read proc
	do
		frpid=($proc)
		kill -9 ${frpid[0]} 2>/dev/null
	done
	exit 0
fi