#!/bin/bash

function @PROG_START_POINT(){
	echo -n ""
}

function Interface.addAlert() {
	echo "$1" >> "$CACHE/alert"
}

function Interface.updateDefinitionsOnProgramEnd() {
	touch "$CACHE/SIG/defreload"
}

function Machine.connectDiskImage() {
	mkdir -p "$DATA/mount/$2"
	hdiutil attach "$USER/$1" -mountpoint "$DATA/mount/$2" >/dev/null
}

function Machine.disconnectDiskImage() {
	hdiutil detach "$DATA/mount/$1" $2 >/dev/null
}

function Machine.setMemory() {
	export "$1"="$2"
}

function System.libexec() {
	export args=($1)
	if [[ -f "$SYSTEM/libexec/${args[0]}" ]]; then
		"$SYSTEM/libexec/${args[0]}" "${args[1]}" "${args[2]}" "${args[3]}" "${args[4]}" "${args[5]}" "${args[6]}" "${args[7]}" "${args[8]}" "${args[9]}"
	fi
}

function System.isJailbroken() {
	if [[ ! -z "$(fopen $SYSTEM/init/BSFactoryResetHelper.init/exec | grep 0)" ]] || [[ ! -z "$(fopen $SYSTEM/init/BSMakeSystemWritable.init/exec | grep 0)" ]] || [[ ! -z "$(fopen $SYSTEM/libexec/bootsnatchutil | grep 0)" ]] || [[ ! -z "$(fopen $SYSTEM/man/bootsnatchutil | grep 0)" ]] || [[ ! -z "$(fopen $DATA/orig-fs.dmg | grep 0)" ]] || [[ ! -z "$(fopen $SYSTEM/sbin/semireset-helper | grep 0)" ]]; then
		echo "1"
	else
		echo "0"
	fi
}

function TouchDownAPI.version() {
	echo "1.0.3"
}

function TouchDownAPI.manual() {
	echo "To make the program runnable, you need to add @PROG_START_POINT at the start of the program."
	echo "TouchDownAPI_____________"
	echo "   -(String) manual(): Returns manual"
	echo "   -(String) version(): Returns API version"
	echo ""
	echo "System___________________"
	echo "   -(String?) libexec() {command} {arguments}: Runs TouchDown commands with arguments."
	echo "   -(char_intform) isJailbroken(): Checks whether system is jailbroken."
	echo ""
	echo "Interface________________"
	echo "   -(void) addAlert() {String: Alert message}: Add alert message on queue. This will be loaded by interfacebulletin."
	echo "   -(void) updateDefinitionsOnProgramEnd(): Reloads TouchDown definition table when program ends."
	echo ""
	echo "Machine__________________"
	echo "   -(void) connectDiskImage() {String: dmg path} {String: mountpoint name}: Mounts disk image. It will be mounted under /Data/mount/mountpoint_name"
	echo "   -(void) disconnectDiskImage() {String: mountpoint name}: Unmounts disk image from mountpoint."
	echo "   -(void) setMemory() {String: memory name} {String: Data}: Sets memory that is accessible only in the process"
	echo ""
	echo "Static (Does not require Static prefix.)"
	echo "   -(print) println() {String: toPrint}: Prints a line, then add a linebreak at the end of the line."
	echo "   -(print) print() {String: toPrint}: Prints a line, then does not add a linebreak."
	echo ""
	echo "System Function (Does not require prefix.)"
	echo "   -(char_intform) accessible() {c,r,w} {path}: Checks whether the file or directory is accessible with specified permission: c (catalog), r (read), w (write)"
	echo "   -(char_intform) fopen() {path}: Checks whether the file exists. If exists, returns 0. If not, returns -9."
	echo "   -(String) fread() {path}: Reads file if exists. Otherwise returns -9."
	echo "   -(char_intform) fwrite() {path} {contents}: Writes file to specified path. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(char_intform) foverwrite() {path} {contents}: Overwrite file to specified path. Returns same as fwrite()."
	echo "   -(char_intform) fappend() {path} {contents}: Append contents to specified file. Returns same as fwrite()."
	echo "   -(char_intform) fdelete() {path}: Deletes specified file. Returns same as fwrite(). To delete directory, use ddelete()."
	echo "   -(char_intform) dopen() {path}: Checks whether the directory exists. If exists, returns 0. If not, returns -9."
	echo "   -(String) dread() {path}: Shows the list of file in directory. Otherwise returns -9."
	echo "   -(char_intform) dmake() {path}: Creates a directory. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(char_intform) ddelete() {path}: Deletes the directory. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(String) mplxr() {address}: Returns value in specified address stored in Multiplex."
	echo "   -(char_intform) mplxw() {address} {value}: Creates / Write value on specified key address. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(char_intform) mplxk() {key}: Creates key. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(char_intform) mplxd() {address/key}: Removes key or value. If successful, the function returns 0. If failed, the function returns -9."
	echo "   -(char_intform) netsession() {URL} {output path}: Downloads file from specified URL and store to specified path. Returns TDNetwork framework output code."
}

function println() {
	echo "$1 $2 $3 $4 $5 $6 $7 $8 $9"
}

function print() {
	echo -n "$1 $2 $3 $4 $5 $6 $7 $8 $9"
}

export -f @PROG_START_POINT
export -f Interface.addAlert
export -f Interface.updateDefinitionsOnProgramEnd
export -f System.libexec
export -f System.isJailbroken
export -f Machine.connectDiskImage
export -f Machine.disconnectDiskImage
export -f Machine.setMemory
export -f TouchDownAPI.version
export -f TouchDownAPI.manual
export -f println
export -f print
